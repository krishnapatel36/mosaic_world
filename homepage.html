<!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Image Capture for Mosaic</title>
     <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
     <style>
         body {
             background-color: #000;
             color: #fff;
             font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
             text-align: center;
             margin: 0;
             padding: 0;
         }
 
         p {
             font-size: 1.5rem;
             font-weight: bold;
             margin-top: 20px;
             color: #fff;
         }
 
         #camera_section {
             position: relative;
             display: inline-block;
         }
 
         #my_camera {
             width: 400px;
             height: 400px;
             border: 1px solid #fff;
             margin-top: 10px;
         }
 
         #bounding_box {
             position: absolute;
             border: 3px dashed red;
             width: 200px;
             height: 200px;
             left: 100px; /* Centers the box horizontally */
             top: 100px; /* Centers the box vertically */
             z-index: 2;
         }
 
         button, select {
             margin-top: 10px;
             padding: 10px;
             font-size: 1rem;
             cursor: pointer;
             border: none;
             border-radius: 5px;
             color: #fff;
             background-color: #007bff;
             transition: background-color 0.3s ease;
         }
 
         button:hover, select:hover {
             background-color: #0056b3;
         }
 
         #outputImage {
             display: none; /* Hide the processed image display */
         }
 
         select {
             background-color: #1c1c1c;
             border: 1px solid #fff;
         }
 
         @media (max-width: 768px) {
             #my_camera {
                 width: 100%;
                 height: auto;
             }
 
             .container {
                 padding: 15px;
             }
         }
 
         @media (max-width: 576px) {
             p {
                 font-size: 1rem;
             }
 
             button, select {
                 font-size: 0.875rem;
                 padding: 8px;
             }
         }
     </style>
 </head>
 <body>
     <img class="w-100" style="height: auto; max-height: 200px;" src="iitgn_logo.png" alt="IITGN Logo">
     <br>
     <div class="container">
         <p>Position your face inside the red box and capture your image for the mosaic</p>
 
         <!-- Webcam Section with Bounding Box -->
         <div id="camera_section">
             <div id="my_camera"></div>
             <div id="bounding_box"></div>
         </div>
         <br>
         <!-- Button to capture image from webcam -->
         <center>
             <button onclick="take_snapshot()">Take Snapshot</button>
         </center>
         <br>
         <!-- File input for uploading image -->
         <center>
             <input type="file" id="file_input" accept="image/*" onchange="handleFileSelect(event)">
         </center>
         <br>
         <div>
             <select id="page_selector">
                 <option value="1">Sticky Notes mosaic</option>
                 <option value="2">Push pin mosaic</option>
                 <option value="3">Single sided dice mosaic</option>
                 <option value="4">Single sided Rubik's cube mosaic</option>
                 <option value="5">Bindi mosaic</option>
             </select>
             <button id="save_button" onclick="processImage()">Use the image</button>
         </div>
         <br>
         
         <div id="results"></div>
         <center><h1>Captured or Uploaded Image</h1></center>
         <img id="outputImage" alt="Processed Image">
     </div>
     
     <script src="https://cdnjs.cloudflare.com/ajax/libs/webcamjs/1.0.26/webcam.min.js"></script>
     <script>
         const API_KEY = 'UYjC6GZBiCKthwSm89n8eQwe'; // Replace with your API key for background removal
 
         // Configure the webcam
         Webcam.set({
             width: 400,
             height: 400,
             image_format: 'jpeg',
             jpeg_quality: 90
         });
 
         // Attach the webcam stream to the HTML element
         Webcam.attach('#my_camera');
 
         // Function to capture the image
         function take_snapshot() {
             Webcam.snap(function(data_uri) {
                 // Display the captured image in the results div
                 document.getElementById('results').innerHTML = 
                     '<img id="captured_image" src="'+data_uri+'"/>';
             });
         }
 
         // Function to handle file selection
         function handleFileSelect(event) {
             const file = event.target.files[0];
             if (file) {
                 const reader = new FileReader();
                 reader.onload = function(e) {
                     document.getElementById('results').innerHTML = 
                         '<img id="captured_image" src="'+e.target.result+'"/>';
                 };
                 reader.readAsDataURL(file);
             }
         }
 
         // Function to process the captured or uploaded image
         function processImage() {
             const image = document.getElementById('captured_image').src;
             removeBackgroundAndAddBlackBackground(image);
         }
 
         function removeBackgroundAndAddBlackBackground(imageUrl) {
             const img = new Image();
             img.crossOrigin = 'Anonymous'; // Handle CORS
             img.onload = function () {
                 const canvas = document.createElement('canvas');
                 const ctx = canvas.getContext('2d');
                 canvas.width = img.width;
                 canvas.height = img.height;
 
                 // Draw black background
                 ctx.fillStyle = 'White';
                 ctx.fillRect(0, 0, canvas.width, canvas.height);
 
                 // Draw the image on top
                 ctx.drawImage(img, 0, 0);
 
                 // Process image to remove background
                 processImageOnServer(canvas.toDataURL());
             };
             img.src = imageUrl;
         }
 
         function processImageOnServer(imageDataUrl) {
             const formData = new FormData();
             formData.append('image_file', dataURLtoBlob(imageDataUrl));
 
             fetch('https://api.remove.bg/v1.0/removebg', {
                 method: 'POST',
                 headers: {
                     'X-Api-Key': API_KEY
                 },
                 body: formData
             })
             .then(response => response.blob())
             .then(blob => {
                 const url = URL.createObjectURL(blob);
                 // Add black background to the image with removed background
                 const img = new Image();
                 img.onload = function () {
                     const canvas = document.createElement('canvas');
                     const ctx = canvas.getContext('2d');
                     canvas.width = img.width;
                     canvas.height = img.height;
 
                     // Draw black background
                     ctx.fillStyle = 'White';
                     ctx.fillRect(0, 0, canvas.width, canvas.height);
 
                     // Draw the processed image on top
                     ctx.drawImage(img, 0, 0);
 
                     // Set the output image source to the canvas data URL
                     const finalImageUrl = canvas.toDataURL();
                     const outputImage = document.getElementById('outputImage');
                     if (outputImage) {
                         outputImage.src = finalImageUrl;
                     }
 
                     // Store the final image URL in local storage and redirect
                     localStorage.setItem('finalImageUrl', finalImageUrl);
                     redirect_with_image();
                 };
                 img.src = url;
             })
             .catch(error => console.error('Error:', error));
         }
 
         function dataURLtoBlob(dataURL) {
             const [header, data] = dataURL.split(',');
             const mime = header.split(':')[1].split(';')[0];
             const binary = atob(data);
             const array = [];
             for (let i = 0; i < binary.length; i++) {
                 array.push(binary.charCodeAt(i));
             }
             return new Blob([new Uint8Array(array)], { type: mime });
         }
 
         function redirect_with_image() {
             // Get the selected page
             const selectedPage = document.getElementById('page_selector').value + '.html';
 
             // Redirect to the selected page
             window.location.href = selectedPage;
         }
     </script>   
 </body>
 </html>
 
